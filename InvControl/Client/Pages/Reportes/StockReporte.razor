@page "/reporte/stock"
@using InvControl.Shared.Filtros
@attribute [Authorize]

@inject UsuariosService UsuariosService
@inject SKUService SKUService
@inject ReporteService ReporteService
@inject NotificationService NotificationService

@if (showForm)
{
    <RadzenText TagName="TagName.H3" TextStyle="TextStyle.H3" TextAlign="TextAlign.Center" Text="Reporte de stock" class="rz-mb-3" />

    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="5px" Wrap="FlexWrap.Wrap" class="rz-mb-3">
        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Nombre del SKU:" Component="nombre" />
            <RadzenTextBox @bind-Value="@StockFiltro.Nombre" MaxLength="50" Name="nombre" AutoCompleteType="AutoCompleteType.Off" Style="width: 15rem;" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Marca:" Component="marca" />
            <RadzenDropDown Data="marcas" @bind-Value="StockFiltro.IdMarca" TextProperty="@nameof(Marca.Descripcion)" ValueProperty="@nameof(Marca.IdMarca)"
                            Style="width: 15rem;" Name="marca" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Especial:" Component="especial" />
            <RadzenDropDown Data="estados" @bind-Value="StockFiltro.Estado" TextProperty="@nameof(Estado.Description)" ValueProperty="@nameof(Estado.Value)"
                            Placeholder="Todos" Style="width: 7rem;" Name="especial" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Stock min.:" Component="stockMin" />
            <RadzenNumeric @bind-Value="StockFiltro.StockMinimo" Min="-999999" Max="999999" ShowUpDown="false" TextAlign="TextAlign.Right" Name="stockMin" Style="width: 7rem;" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Stock max.:" Component="stockMax" />
            <RadzenNumeric @bind-Value="StockFiltro.StockMaximo" Min="0" Max="999999" ShowUpDown="false" TextAlign="TextAlign.Right" Name="stockMax" Style="width: 7rem;" Disabled="isLoading" />
        </RadzenStack>

        <RadzenButton ButtonStyle="ButtonStyle.Secondary" Text="Buscar" Icon="search" Click="HandleClickSearch" Style="height: 1rem;" Disabled="isLoading" />
    </RadzenStack>
}
else
{
    <Loader />
}

@code {
    bool showForm, isLoading;

    StockFiltro StockFiltro { get; set; } = new();

    List<Marca> marcas = new();
    List<Estado> estados = new();

    protected override async Task OnInitializedAsync()
    {
        await UsuariosService.GetValidarAcceso();
        marcas = await SKUService.GetMarcas();
        marcas.Insert(0, new() { IdMarca = 0, Descripcion = "Todos" });
        estados.Add(new(null, "Todos"));
        estados.Add(new(true, "Sí"));
        estados.Add(new(false, "No"));

        StockFiltro.IdMarca = 0;
        showForm = true;
    }

    private async Task HandleClickSearch()
    {
        isLoading = true;
        var result = await ReporteService.GetStockReportes(StockFiltro);
        isLoading = false;

        if (!result)
            NotificationService.Notify(summary: Message.EmptySearch);
    }
}
