@page "/reporte/stock/movimientos"
@using InvControl.Shared.Filtros
@attribute [Authorize]

@inject UsuariosService UsuariosService
@inject StockService StockService
@inject CanalesVentasService CanalesVentasService
@inject NotificationService NotificationService
@inject ReporteService ReporteService

@if (showForm)
{
    <RadzenText TagName="TagName.H3" TextStyle="TextStyle.H3" TextAlign="TextAlign.Center" Text="Reporte de movimientos de stock" class="rz-mb-3" />

    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="5px" Wrap="FlexWrap.Wrap" class="rz-mb-3">
        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Tipo movimiento:" Component="tipoMovimiento" />
            <RadzenDropDown Data="tiposMovimientos" @bind-Value="stockMovimientoFiltro.IdTipoMovimiento" TextProperty="@nameof(TipoMovimiento.Nombre)" ValueProperty="@nameof(TipoMovimiento.IdTipoMovimiento)"
                            Style="width: 15rem;" Name="tipoMovimiento" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Código del SKU:" Component="codigo" />
            <RadzenNumeric @bind-Value="stockMovimientoFiltro.Codigo" Min="0" Max="999999" ShowUpDown="false" TextAlign="TextAlign.Right" Name="codigo" Style="width: 7rem;" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Nombre del SKU:" Component="nombre" />
            <RadzenTextBox @bind-Value="@stockMovimientoFiltro.Nombre" MaxLength="50" Name="nombre" AutoCompleteType="AutoCompleteType.Off" Style="width: 15rem;" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Movimiento desde:" Component="desde" />
            <RadzenDatePicker @bind-Value="@stockMovimientoFiltro.FechaDesde" ShowCalendarWeek Max="DateTime.Now" DateFormat="dd/MM/yyyy" ShowTime="false" AllowInput="false" Name="fechaDesde" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Movimiento hasta:" Component="hasta" />
            <RadzenDatePicker @bind-Value="@stockMovimientoFiltro.FechaHasta" ShowCalendarWeek Max="DateTime.Now" DateFormat="dd/MM/yyyy" ShowTime="false" AllowInput="false" Name="hasta" Disabled="isLoading" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Vertical" Gap="5px">
            <RadzenLabel Text="Canal de venta:" Component="canalVenta" />
            <RadzenDropDown Data="canalesVentas" @bind-Value="stockMovimientoFiltro.IdCanalVenta" TextProperty="@nameof(CanalVenta.Nombre)" ValueProperty="@nameof(CanalVenta.IdCanalVenta)"
                            AllowClear="true" Style="width: 15rem;" Name="canalVenta" Disabled="isLoading" />
        </RadzenStack>

        <RadzenButton ButtonStyle="ButtonStyle.Secondary" Text="Buscar" Icon="search" Click="HandleClickSearch" Style="height: 1rem;" Disabled="isLoading" />
    </RadzenStack>
}
else
{
    <Loader />
}

@code {
    StockMovimientoFiltro stockMovimientoFiltro;
    List<TipoMovimiento> tiposMovimientos;
    List<CanalVenta> canalesVentas;

    bool showForm, isLoading;

    protected override async Task OnInitializedAsync()
    {
        await UsuariosService.GetValidarAcceso();
        tiposMovimientos = await StockService.GetTiposMovimientos(null, null, null, null);
        canalesVentas = await CanalesVentasService.GetCanalesVentas();
        stockMovimientoFiltro = new();
        stockMovimientoFiltro.IdTipoMovimiento = tiposMovimientos[0].IdTipoMovimiento;
        stockMovimientoFiltro.FechaDesde = DateTime.Today;
        stockMovimientoFiltro.FechaHasta = DateTime.Today.AddHours(23).AddMinutes(59).AddSeconds(59);
        showForm = true;
    }

    private async Task HandleClickSearch()
    {
        isLoading = true;
        var result = await ReporteService.GetStockMovimientosReportes(stockMovimientoFiltro);
        isLoading = false;

        if (!result)
            NotificationService.Notify(summary: Message.EmptySearch);
    }
}
